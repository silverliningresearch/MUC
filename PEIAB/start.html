<html>
    <head>
		<title>Passenger Experience Survey – Departures</title>
    <link rel="icon" type="image/x-icon" href="images/favicon.svg">
  
    <script src="data/quota_data.js"></script>
    <script src="data/invalid_cases.js"></script>
    <script src="data/MUC_departures_flight_list.js"></script>		
    <script src="scripts/PrepareData.js"></script>
		<script src="scripts/CalculateData.js"></script>
    <script src="scripts/CalculateDataArrival.js"></script>
    <script src="scripts/flight_search.js"></script>

    <script src="data/ASQ_Quota_Airline_Dest.js"></script>
    <script src="data/ASQ_Quota_Airlines.js"></script>
    <script src="data/ASQ_Quota_Dest.js"></script>
    <script src="scripts/PrepareData_ASQ.js"></script>
    <script src="scripts/CalculateData_ASQ.js"></script>
    
    <script type="text/javascript" src="https://silverliningresearch.github.io/daily_plan_data_sur_v3/MUC_PEIAB/MUC_Gate_Info.js"></script>
    <script type="text/javascript" src="https://silverliningresearch.github.io/daily_plan_data_sur_v3/MUC_PEIAB/interview_statistics.js"></script>
    <script type="text/javascript" src="https://silverliningresearch.github.io/daily_plan_data_sur_v3/MUC_PEIAN/interview_statistics.js"></script>

    <script type="text/javascript" src="https://silverliningresearch.github.io/daily_plan_data_asq/MUC/Departures/interview_statistics_asq.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

    <link href="css/styles_v2.css" rel ="stylesheet" type="text/css" />
    <style>
      .custom_filter{
        font-size: 15px;
        padding: 10px 8px 10px 14px;
        background: #eee;
        border: 1px solid #ccc;
        border-radius: 6px;
        overflow: hidden;
        position: relative;
      }

      .custom_filter .select{
        width: 120%;
        background:url('arrow.png') no-repeat;
        background-position:80% center;
      }

      .custom_filter .select select{
        background: transparent;
        line-height: 1;
        border: 0;
        padding: 0;
        border-radius: 0;
        width: 120%;
        position: relative;
        z-index: 10;
        font-size: 1em;
      }

      .table-font {
        font-size: 16px;
        /* height: 18px; */
      }

      .filter-font {
        font-size: 16px;
        /* height: 18px; */
      }

      .button {
        background-color: #4CAF50; /* Green */
        border: none;
        color: white;
        padding: 15px 32px;
        text-align: center;
        text-decoration: none;
        display: inline-block;
        font-size: 16px;
        width: 300px;
        margin: 4px 2px;
        cursor: pointer;
      }

      .red {background-color: #f44336;;} /* Red */
      .blue {background-color: #0693e3;} /* Blue */ 


      .headerbackground {background-color: #66CCFF;;} /* Blue */ 
      

      h1 {text-align: center;}


    </style>

		<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
      function isNextDay()
      {
        const queryString = window.location.search;
        const urlParams = new URLSearchParams(queryString);

        //?nextday=true
        return(urlParams.has('nextday'));
      }
      //google.charts.load('current', {'packages':['table']});
      google.charts.load('current', {'packages':['table','corechart', 'controls']});
      google.charts.setOnLoadCallback(drawTable);

      function drawTable() {
        //to merge ASQ
        CalculateAirportAirLineReport_asq();

        CalculateAirportAirLineReport();
        CalculateArrival();

        for (i = 0; i < daily_plan_data.length; i++) {
          daily_plan_data[i].Survey = "PEI AB"; 
          daily_plan_data[i].ASQ_remark = "";
        }

        for (i = 0; i < daily_plan_data_asq.length; i++) {
          if ((daily_plan_data_asq[i].Difference < 0)  //airline-dest still missing data
              ||(daily_plan_data_asq[i].Priority > 0)) // or either airline or dest still missing data
          {
            daily_plan_data_asq[i].Survey = "ASQ";
            daily_plan_data_asq[i].Flight = daily_plan_data_asq[i].Flight_Show;
            daily_plan_data.push(daily_plan_data_asq[i]);
          }
        }

        var data = new google.visualization.DataTable();

        data.addColumn('string', 'Survey');
        data.addColumn('string', 'Date');
        data.addColumn('string', 'Time');
        data.addColumn('number', 'TER');
        data.addColumn('string', 'Gate Area');
        data.addColumn('string', 'Gate');        
        data.addColumn('string', 'Flight');
        data.addColumn('string', 'To');
        //data.addColumn('string', 'Via');
        //data.addColumn('string', 'DOOP');
        data.addColumn('number', 'Remaining Flights');
        data.addColumn('number', 'Quota');
        data.addColumn('number', 'Completed');
				data.addColumn('number', 'Missing');
        data.addColumn('number', 'Completed %');
        
        if (is_the_last_month_of_Quarter_asq()) {
          data.addColumn('string', 'ASQ Notes');
        }
        data.addColumn('number', 'Priority Score');
        data.addColumn('number', 'Priority');

        //sort ascending
        daily_plan_data.sort(function(a, b) {
          return (parseFloat(a.Date_Time) - parseFloat(b.Date_Time));
        });

        //add data
        for (i = 0; i < daily_plan_data.length; i++) {
          var row = daily_plan_data[i];
            { 
              if (is_the_last_month_of_Quarter_asq()) {
                data.addRows([[
                row.Survey, 
                row.Date,
                row.Time, 
                row.TER, row.GateArea, row.Gate,
                row.Flight, row.DestName, 
                //row.Next, 
                //row.doop, 
                Number(row.remaining_flights), 
                Number(row.Quota), Number(row.Completed), Number(row.Difference), 
                Number(row.Completed_percent), 
                row.ASQ_missing,
                Number(row.Prioritisation_score), 
                Number(row.Priority)]]);
              }
              else{
                data.addRows([[
                row.Survey, 
                row.Date,
                row.Time, 
                row.TER, row.GateArea, row.Gate,
                row.Flight, row.DestName, 
                //row.Next, 
                //row.doop, 
                Number(row.remaining_flights), 
                Number(row.Quota), Number(row.Completed), Number(row.Difference), 
                Number(row.Completed_percent), 
                //row.ASQ_missing,
                Number(row.Prioritisation_score), 
                Number(row.Priority)]]);
              }
            }
          }

          //highlight priority one
          var priority_col = data.getNumberOfColumns()-1; //last one
          var remaining_flights_col = data.getNumberOfColumns()-7; 
          for (var i = 0; i < data.getNumberOfRows(); i++) {
            for (j=0; j < data.getNumberOfColumns(); j++) {
              if (data.getValue(i, priority_col) ==1) 
              {
                data.setProperty(i, j, 'style', 'background-color:#FFCCCB');
              }
              else if ( data.getValue(i, priority_col) ==2) 
              {
                data.setProperty(i, j, 'style', 'background-color:#F67052');
              }
            }
          }

        //create a dashboard.
        var dashboard = new google.visualization.Dashboard(
        document.getElementById('dashboard_div'));

        //create survey  fiter
        var options_Survey = {
          'filterColumnLabel': 'Survey',
          "ui": {"label": "", 
          "labelStacking": 'horizotal',
          "caption": "Select Survey:",
          },

        };

        var tableFilter_Survey = new google.visualization.ControlWrapper({
          'controlType': 'CategoryFilter',
          'containerId': 'filter_survey',
          'options': options_Survey,
          state: {
              selectedValues: ['PEI AB']
          }
        });
        

          //create fiter terminal 
          var options_Terminal = {
          'filterColumnLabel': 'TER',
          "ui": {"label": "", 
                "labelStacking": 'horizotal',
                "caption": "Select Terminal",
                }
        };

        var tableFilter_Terminal = new google.visualization.ControlWrapper({
          'controlType': 'CategoryFilter',
          'containerId': 'filter_terminal',
          'options': options_Terminal
        });
        
        var gate_options = {
          'filterColumnLabel': 'Gate Area',
          "ui": {"label": "", 
                "labelStacking": 'horizotal',
                "caption": "Select Gate Area",
                }
        };

        var gateFilter = new google.visualization.ControlWrapper({
          'controlType': 'CategoryFilter',
          'containerId': 'filter_gate',
          'options': gate_options
        });

        var date_options = {
          'filterColumnLabel': 'Date',
          "ui": {"label": "", 
                "labelStacking": 'horizotal',
                "caption": "Select Date",
                }
        };

        var dateFilter = new google.visualization.ControlWrapper({
          'controlType': 'CategoryFilter',
          'containerId': 'filter_date',
          'options': date_options
        });

        // Create table
        var tableChart = new google.visualization.ChartWrapper({
          'chartType': 'Table',
          'containerId': 'table_div',
          'options': {
            'allowHtml': true, 
            //'cssClassNames': {tableCell: 'table-font', headerRow: 'table-font', headerCell: 'googleHeaderCell' },
            'cssClassNames': {tableCell: 'table-font', headerRow: 'headerbackground', headerCell: 'googleHeaderCell' },
            //'sortColumn': 1, //time
            'showRowNumber': false, 'width': '100%', 'height': '100%'
          }
        });

        dashboard.bind([tableFilter_Survey, tableFilter_Terminal, gateFilter, dateFilter], tableChart);

        var view = new google.visualization.DataView(data);
        view.hideColumns([priority_col, priority_col-1]); //hide priority one
        //document.getElementById("filter_div").style.display = "none";
        dashboard.draw(view);

        //Update time info
        //document.getElementById("download_time_ab").innerHTML = "Data updated at: " + download_time_ab;

        //overall_status
        var overall_status =  "PEI AB: " + "Total quota: " + total_quota;
        overall_status += " - Total completed: " + total_completed ;
        overall_status +=  " (" + total_completed_percent +  "%)" ;
        //overall_status += " - Quota completed: " + total_quota_completed;
        document.getElementById("overall_status").innerHTML =overall_status;

        //overall_status
        var overall_arrival_status =  "PEI AN: " + "Total quota: " + total_arrival_quota;
        overall_arrival_status += " - Total completed: " + total_arrival_completed;
        overall_arrival_status +=  " (" + total_arrival_completed_percent +  "%)"+ " | " + "Data updated at: " + download_time_an;;
        document.getElementById("overall_arrival_status").innerHTML =overall_arrival_status;

        //overall_status
        var overall_status_asq =  "ASQ: " + "Total quota: " + total_quota_asq;
        overall_status_asq += " - Total completed: " + total_completed_asq ;
        overall_status_asq +=  " (" + total_completed_percent_asq +  "%)" + " | " + "Data updated at: " + download_time_asq;;
        //overall_status += " - Quota completed: " + total_quota_completed;
        document.getElementById("overall_status_asq").innerHTML =overall_status_asq;
      }
    
    function start_new_interview() {
      console.log("start_new_interview");
      window.localStorage.clear();

      let url = "https://silverliningresearch.github.io/MUC/PEIAB/survey.html";
      window.location.href = url;
    }

    function resume_curent_interview() {
      console.log("resume_curent_interview");
      let url = "https://silverliningresearch.github.io/MUC/PEIAB/survey.html";
      window.location.href = url;
    }

 
    </script>
  </head>
  <body>
  </br>
    <h2 align="center">Passenger Experience Survey – Departures</h2>
  </br>
  <div align="center">
    <button onclick="start_new_interview()" class="button red">Start a new interview</button>
    <button onclick="resume_curent_interview()" class="button blue">Resume the current interview </button>
  </div>
  <p>
	</br>
    *<strong>Resume the current interview</strong> will continue from the last question in the current interview.</br>
	</br> 
  </p>

    <div style="background-color:#66CCFF;">
      </br>
    </div>

    <!-- <h5 id="download_time_ab"></h5> -->
    <h4 id="overall_status"></h4>

    <h4 id="overall_arrival_status"></h4>

    <h4 id="overall_status_asq"></h4>

    
    <div class="custom_filter">
      <label for="show_hide_closed_target">Show fligths with closed target:</label>
      <select id="show_hide_closed_target" onchange="drawTable()">
        <option value="No">No		
        <option value="Yes">Yes
      </select>
    </div>

    <div id="dashboard_div">
      <!--Divs that will hold each control and chart-->
      <div id="filter_survey"></div>
      <div id="filter_terminal"></div>
      <div id="filter_gate" style="font-size: 15px"> </div>
      <div id="filter_date" style="font-size: 15px"> </div>

      </br>
      <div id="table_div"></div>
    </div>

  </body>
</html>
